import{_ as k,C as o,o as h,c as p,j as i,a as e,E as t,aA as n,w as l}from"./chunks/framework.bUxuWUtX.js";const D=JSON.parse('{"title":"CellLists","description":"","frontmatter":{},"headers":[],"relativePath":"modules/CellLists.md","filePath":"modules/CellLists.md","lastUpdated":null}'),r={name:"modules/CellLists.md"},d={class:"jldocstring custom-block",open:""},c={class:"MathJax",jax:"SVG",overflow:"linebreak"},E={style:{"vertical-align":"0"},xmlns:"http://www.w3.org/2000/svg",width:"1.993ex",height:"1.545ex",role:"img",focusable:"false",viewBox:"0 -683 881 683"},g={class:"jldocstring custom-block",open:""},y={class:"jldocstring custom-block",open:""},u={class:"jldocstring custom-block",open:""},C={class:"jldocstring custom-block",open:""},F={class:"jldocstring custom-block",open:""},b={class:"jldocstring custom-block",open:""};function f(m,s,_,A,x,v){const a=o("Badge");return h(),p("div",null,[s[32]||(s[32]=i("h1",{id:"CellLists",tabindex:"-1"},[e("CellLists "),i("a",{class:"header-anchor",href:"#CellLists","aria-label":'Permalink to "CellLists {#CellLists}"'},"​")],-1)),i("details",d,[i("summary",null,[s[0]||(s[0]=i("a",{id:"VortexPasta.CellLists",href:"#VortexPasta.CellLists"},[i("span",{class:"jlbinding"},"VortexPasta.CellLists")],-1)),s[1]||(s[1]=e()),t(a,{type:"info",class:"jlObjectType jlModule",text:"Module"})]),s[6]||(s[6]=n('<div class="language-julia vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">julia</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">CellLists</span></span></code></pre></div>',1)),i("p",null,[s[3]||(s[3]=e("Module implementing the cell lists algorithm over ",-1)),i("mjx-container",c,[(h(),p("svg",E,[...s[2]||(s[2]=[i("g",{stroke:"currentColor",fill:"currentColor","stroke-width":"0",transform:"scale(1,-1)"},[i("g",{"data-mml-node":"math","data-latex":"N"},[i("g",{"data-mml-node":"mi","data-latex":"N"},[i("path",{"data-c":"1D441",d:"M864 683C845 683 783 680 764 680C745 680 682 683 663 683C648 683 641 675 641 659C641 650 648 645 663 644C705 644 726 631 726 605C726 599 725 592 724 585L616 157L401 662C393 681 391 683 366 683L233 683C209 683 200 681 200 659C200 649 211 644 232 644C274 644 295 643 296 640L163 110C154 71 131 49 95 42C69 39 39 43 39 15C39 5 45 0 56 0C74 0 136 3 155 3C174 3 238 0 257 0C272 0 279 8 279 24C279 33 271 38 255 39C214 40 194 53 194 78C194 83 195 90 197 100L326 611L576 21C582 7 590 0 599 0C608 0 614 8 618 24L757 574C770 625 798 643 860 644C874 645 881 653 881 669C878 678 877 683 864 683Z"})])])],-1)])]))]),s[4]||(s[4]=e("-dimensional periodic domains.",-1))]),s[7]||(s[7]=i("p",null,[e("See the "),i("a",{href:"https://en.wikipedia.org/wiki/Cell_lists",target:"_blank",rel:"noreferrer"},"Wikipedia article"),e(" for some details.")],-1)),t(a,{type:"info",class:"source-link",text:"source"},{default:l(()=>[...s[5]||(s[5]=[i("a",{href:"https://github.com/jipolanco/VortexPasta.jl/blob/dbbd29218d5d247bbb53e6266b9f5b36a4f04d11/src/CellLists/CellLists.jl#L1-L7",target:"_blank",rel:"noreferrer"},"source",-1)])]),_:1})]),s[33]||(s[33]=i("h2",{id:"Types",tabindex:"-1"},[e("Types "),i("a",{class:"header-anchor",href:"#Types","aria-label":'Permalink to "Types {#Types}"'},"​")],-1)),i("details",g,[i("summary",null,[s[8]||(s[8]=i("a",{id:"VortexPasta.CellLists.PeriodicCellList",href:"#VortexPasta.CellLists.PeriodicCellList"},[i("span",{class:"jlbinding"},"VortexPasta.CellLists.PeriodicCellList")],-1)),s[9]||(s[9]=e()),t(a,{type:"info",class:"jlObjectType jlType",text:"Type"})]),s[11]||(s[11]=n(`<div class="language-julia vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">julia</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">PeriodicCellList</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    [backend </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> CPU</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">()],</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    rs_cut</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">::</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">NTuple{N, Real}</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, periods</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">::</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">NTuple{N, Real}</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    [nsubdiv </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> Val</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">1</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)];</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">) </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">-&gt;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> PeriodicCellList{N}</span></span></code></pre></div><p>Construct a cell list for dealing with pair interactions in <code>N</code> dimensions.</p><p>The cutoff distances <code>rs_cut</code> (which can be different in each direction) don&#39;t need to exactly divide the domain period <code>L</code> into equal pieces. In that case the cutoff distances will be adjusted (slightly increased) to fit the domain period.</p><p>Note that this cell-lists implementation can identify pairs which are slightly beyond the given cut-off distance. For performance reasons, such pairs are still returned, and it&#39;s up to the user to see whether such pairs should still be computed or not depending on whether a strict cut-off distance is wanted.</p><p>Optionally, one can choose to subdivide each cell (of size <code>≈ rcut</code>) onto <code>nsubdiv</code> subcells. This can significantly improve performance, since it allows to discard some spurious pair interactions (i.e. beyond the chosen cutoff radius) as described <a href="https://en.wikipedia.org/wiki/Cell_lists#Improvements" target="_blank" rel="noreferrer">here</a>. In practice, a value of <code>2</code> or <code>3</code> can significantly improve performance compared to no subdivision (<code>1</code>). For convenience, it can be passed as <code>nsubdiv = Val(M)</code> or as <code>nsubdiv = static(M)</code>.</p><p>Infinite non-periodic domains (in the sense of <code>period = Infinity()</code>) are not supported.</p><p><strong>GPU usage</strong></p><p>To run on GPUs, pass a KernelAbstractions backend such as <code>CUDABackend</code> or <code>ROCBackend</code> as the first argument.</p><p>If multiple GPUs are available, make sure to activate the device where computations should be performed <em>before</em> constructing a <code>PeriodicCellList</code>. For example:</p><div class="language-julia vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">julia</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">using</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> KernelAbstractions</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">:</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> KernelAbstractions </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">as</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> KA</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">backend </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> ROCBackend</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">()</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">device_id </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 2</span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">  # assuming there are two or more available GPUs</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">KA</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">.</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">device!</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(backend, device_id)</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">cl </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> PeriodicCellList</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(backend, </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">...</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)</span></span></code></pre></div>`,10)),t(a,{type:"info",class:"source-link",text:"source"},{default:l(()=>[...s[10]||(s[10]=[i("a",{href:"https://github.com/jipolanco/VortexPasta.jl/blob/dbbd29218d5d247bbb53e6266b9f5b36a4f04d11/src/CellLists/CellLists.jl#L32-L74",target:"_blank",rel:"noreferrer"},"source",-1)])]),_:1})]),s[34]||(s[34]=i("h2",{id:"Functions",tabindex:"-1"},[e("Functions "),i("a",{class:"header-anchor",href:"#Functions","aria-label":'Permalink to "Functions {#Functions}"'},"​")],-1)),i("details",y,[i("summary",null,[s[12]||(s[12]=i("a",{id:"VortexPasta.CellLists.set_elements!",href:"#VortexPasta.CellLists.set_elements!"},[i("span",{class:"jlbinding"},"VortexPasta.CellLists.set_elements!")],-1)),s[13]||(s[13]=e()),t(a,{type:"info",class:"jlObjectType jlFunction",text:"Function"})]),s[15]||(s[15]=n('<div class="language-julia vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">julia</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">CellLists</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">.</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">set_elements!</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">([get_coordinate</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">::</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">Function</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">], cl</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">::</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">PeriodicCellList</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, xp</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">::</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">AbstractVector</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">; folded </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> Val</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">false</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">))</span></span></code></pre></div><p>Set all source elements of the cell list.</p><p>In general <code>xp</code> is a vector of spatial locations.</p><p>Optionally, a <code>get_coordinate</code> function can be passed, which will be applied to each <code>xp[j]</code> in order to obtain a coordinate. By default this is <code>identity</code>.</p><p>Moreover, one may pass <code>folded = Val(true)</code> in case all points in <code>xp</code> have been folded into the main periodic cell (i.e. <code>x⃗ ∈ [0, L]ᵈ</code>), which can speed-up computations. <strong>This is a dangerous option</strong>: if points haven&#39;t been really folded, this will lead to wrong results or crashes.</p><p>This function resets the cell list, removing all previously existent points.</p>',6)),t(a,{type:"info",class:"source-link",text:"source"},{default:l(()=>[...s[14]||(s[14]=[i("a",{href:"https://github.com/jipolanco/VortexPasta.jl/blob/dbbd29218d5d247bbb53e6266b9f5b36a4f04d11/src/CellLists/CellLists.jl#L226-L241",target:"_blank",rel:"noreferrer"},"source",-1)])]),_:1})]),i("details",u,[i("summary",null,[s[16]||(s[16]=i("a",{id:"VortexPasta.CellLists.foreach_pair",href:"#VortexPasta.CellLists.foreach_pair"},[i("span",{class:"jlbinding"},"VortexPasta.CellLists.foreach_pair")],-1)),s[17]||(s[17]=e()),t(a,{type:"info",class:"jlObjectType jlFunction",text:"Function"})]),s[19]||(s[19]=n(`<div class="language-julia vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">julia</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">CellLists</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">.</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">foreach_pair</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    f</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">::</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">Function</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, cl</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">::</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">PeriodicCellList</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, xp_dest</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">::</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">AbstractVector</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    batch_size </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> nothing</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    folded </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> Val</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">false</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">),</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    sort_points </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> true</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)</span></span></code></pre></div><p>Iterate over all point pairs within the chosen cut-off distance.</p><p>A pair is given by a <strong>destination point</strong> <code>xp_dest[i]</code> and a <strong>source point</strong> <code>xp[j]</code>, where <code>xp</code> is the vector of coordinates that was previously passed to <a href="/VortexPasta.jl/v0.32/modules/CellLists#VortexPasta.CellLists.set_elements!"><code>CellLists.set_elements!</code></a>. Note that the vector of destination points <code>xp_dest</code> can be different than that of source points.</p><p>The first argument should be a user-defined function <code>f(x⃗, i::Integer, j::Integer)</code> taking a destination point <code>x⃗ = xp_dest[i]</code> and a pair of destination/source indices <code>(i, j)</code>. Typically, one wants to modify one or more destination vectors at index <code>vp[i]</code>, which can be done within this function.</p><p>On CPUs this function is parallelised using threads. Parallelisation is done at the level of all destination points <code>xp_dest</code>, ensuring that only a single thread can write to a location <code>vp[i]</code> (in other words, atomics are not needed). This function also works on GPUs.</p><p>One may set <code>folded = Val(true)</code> if points in <code>xp_dest</code> have been previously folded. See <a href="/VortexPasta.jl/v0.32/modules/CellLists#VortexPasta.CellLists.set_elements!"><code>set_elements!</code></a> for more details.</p><p>If <code>sort_points = true</code>, destination points will be visited in a spatially-sorted order, which may speed-up memory accesses.</p><p>This function should be called after <a href="/VortexPasta.jl/v0.32/modules/CellLists#VortexPasta.CellLists.set_elements!"><code>CellLists.set_elements!</code></a>.</p><p>See also <a href="/VortexPasta.jl/v0.32/modules/CellLists#VortexPasta.CellLists.foreach_source"><code>CellLists.foreach_source</code></a>.</p><p><strong>Iterating over batches</strong></p><p>Similarly to <a href="/VortexPasta.jl/v0.32/modules/CellLists#VortexPasta.CellLists.foreach_source"><code>foreach_source</code></a>, one can iterate over batches of (up to) <code>W</code> source points at a time (for each single destination point <code>x⃗ = xp_dest[i]</code>). For this one should pass <code>batch_size = Val(W)</code> as a keyword argument. Note that in this case, the user-defined function <code>f</code> is expected to have the signature <code>f(x⃗, i::Integer, js::NTuple{W}, m::Integer)</code>. See <a href="/VortexPasta.jl/v0.32/modules/CellLists#VortexPasta.CellLists.foreach_source"><code>foreach_source</code></a> for details on the last two arguments.</p><p><strong>Example usage</strong></p><div class="language-julia vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">julia</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">julia</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">&gt;</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> using</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> StaticArrays</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">:</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> SVector</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">julia</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">&gt;</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> using</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> LinearAlgebra</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">:</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> ⋅</span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">  # dot product</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">julia</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">&gt;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> r_cut </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 0.4</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">; rs_cut </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (r_cut, r_cut, r_cut);</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">julia</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">&gt;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> Ls </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">2π</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">2π</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">2π</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">);</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">julia</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">&gt;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> nsubdiv </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> Val</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">2</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">);</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">julia</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">&gt;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> cl </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> PeriodicCellList</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">CPU</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(), rs_cut, Ls, nsubdiv)</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">PeriodicCellList{</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">3</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">} with</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">:</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> -</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> backend</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">:</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">         CPU</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">false</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> -</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> number of cells</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">:</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">31</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">31</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">31</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> -</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> period</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">:</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">          (</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">6.283185307179586</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">6.283185307179586</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">6.283185307179586</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> -</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> cell size</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">:</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">       (</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">0.2026833970057931</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">0.2026833970057931</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">0.2026833970057931</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> -</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> effective r_cut</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">:</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">0.4053667940115862</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">0.4053667940115862</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">0.4053667940115862</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> -</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> number of subdivisions</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">:</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 2</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">julia</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">&gt;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> xp </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> [</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">rand</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(SVector{</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">3</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, Float64}) </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">.*</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> Ls </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">for</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> _ </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">in</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 1</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">:</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">1000</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">];  </span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># create source points in [0, L]³</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">julia</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">&gt;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> CellLists</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">.</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">set_elements!</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(cl, xp);  </span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># process source points</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">julia</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">&gt;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> xp_dest </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> [</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">rand</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(SVector{</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">3</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, Float64}) </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">.*</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> Ls </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">for</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> _ </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">in</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 1</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">:</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">200</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">];  </span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># create destination points in [0, L]³</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">julia</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">&gt;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> vp_dest </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> zeros</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">length</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(xp_dest));  </span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># vector where &quot;interactions&quot; will be written to</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">julia</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">&gt;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> CellLists</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">.</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">foreach_pair</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(cl, xp_dest) </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">do</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> x⃗, i, j</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">           # Compute some &quot;influence&quot; of xp[j] on x⃗ == xp_dest[i]</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">           # Note that it is safe to write to vp_dest[i] without atomics, even when running in parallel.</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">           @inbounds</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> vp_dest[i] </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">+=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> x⃗ </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">⋅</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> xp[j]</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">       end</span></span></code></pre></div>`,13)),t(a,{type:"info",class:"source-link",text:"source"},{default:l(()=>[...s[18]||(s[18]=[i("a",{href:"https://github.com/jipolanco/VortexPasta.jl/blob/dbbd29218d5d247bbb53e6266b9f5b36a4f04d11/src/CellLists/CellLists.jl#L286-L363",target:"_blank",rel:"noreferrer"},"source",-1)])]),_:1})]),i("details",C,[i("summary",null,[s[20]||(s[20]=i("a",{id:"VortexPasta.CellLists.foreach_source",href:"#VortexPasta.CellLists.foreach_source"},[i("span",{class:"jlbinding"},"VortexPasta.CellLists.foreach_source")],-1)),s[21]||(s[21]=e()),t(a,{type:"info",class:"jlObjectType jlFunction",text:"Function"})]),s[23]||(s[23]=n('<div class="language-julia vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">julia</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">CellLists</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">.</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">foreach_source</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(f</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">::</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">Function</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, cl</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">::</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">PeriodicCellList</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, x⃗_dest; batch_size </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> nothing</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, folded </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> Val</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">false</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">))</span></span></code></pre></div><p>Iterate over source points which are close to a given destination point <code>x⃗_dest</code>.</p><p>This is similar to <a href="/VortexPasta.jl/v0.32/modules/CellLists#VortexPasta.CellLists.foreach_pair"><code>CellLists.foreach_pair</code></a> but only works on a single destination point. On the CPU, <code>foreach_source</code> is not parallelised. One may want to parallelise at the level of multiple destination points to match the behaviour of <code>foreach_pair</code>.</p><p>The first argument should be a user-defined function <code>f(j::Integer)</code> taking the index <code>j</code> of a source point.</p><p>Performance-wise, this function seems to give similar performance to <code>foreach_pair</code> on CPUs. On GPUs one may prefer to use <code>foreach_pair</code> which is more adapted for GPU computing.</p><p>One may set <code>folded = Val(true)</code> if <code>x⃗_dest</code> has been previously folded. See <a href="/VortexPasta.jl/v0.32/modules/CellLists#VortexPasta.CellLists.set_elements!"><code>set_elements!</code></a> for more details.</p><p><strong>Iterating over batches</strong></p><p>For performance reasons (e.g. to enable SIMD), one may want to iterate over batches of source points in <code>cl</code>. For this, one should pass the keyword argument <code>batch_size = Val(W)</code> where <code>W</code> is the wanted batch size.</p><p>When batching is enabled, the user-defined function <code>f</code> is expected to have the signature <code>f(js::NTuple{W}, m::Integer)</code>, where <code>js</code> are the indices of <code>W</code> nearby source points, and <code>m ∈ 1:W</code> is the number of &quot;valid&quot; points. In other words, indices <code>js[(m + 1):W]</code> should be discarded (or masked out) in the <code>f</code> function. Note that, even though these indices should be ignored to get correct results, these are guaranteed to be valid indices in <code>1:Np</code> (where <code>Np</code> is the number of source points), and thus can be safely used to access source coordinates (which is convenient in the context of SIMD).</p>',9)),t(a,{type:"info",class:"source-link",text:"source"},{default:l(()=>[...s[22]||(s[22]=[i("a",{href:"https://github.com/jipolanco/VortexPasta.jl/blob/dbbd29218d5d247bbb53e6266b9f5b36a4f04d11/src/CellLists/CellLists.jl#L456-L487",target:"_blank",rel:"noreferrer"},"source",-1)])]),_:1})]),i("details",F,[i("summary",null,[s[24]||(s[24]=i("a",{id:"Base.empty!-Tuple{VortexPasta.CellLists.PeriodicCellList}",href:"#Base.empty!-Tuple{VortexPasta.CellLists.PeriodicCellList}"},[i("span",{class:"jlbinding"},"Base.empty!")],-1)),s[25]||(s[25]=e()),t(a,{type:"info",class:"jlObjectType jlMethod",text:"Method"})]),s[27]||(s[27]=n('<div class="language-julia vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">julia</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">Base</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">.</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">empty!</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(cl</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">::</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">PeriodicCellList</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">) </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">-&gt;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> cl</span></span></code></pre></div><p>Remove all elements from the cell list.</p>',2)),t(a,{type:"info",class:"source-link",text:"source"},{default:l(()=>[...s[26]||(s[26]=[i("a",{href:"https://github.com/jipolanco/VortexPasta.jl/blob/dbbd29218d5d247bbb53e6266b9f5b36a4f04d11/src/CellLists/CellLists.jl#L172-L176",target:"_blank",rel:"noreferrer"},"source",-1)])]),_:1})]),i("details",b,[i("summary",null,[s[28]||(s[28]=i("a",{id:"VortexPasta.CellLists.nearby_elements",href:"#VortexPasta.CellLists.nearby_elements"},[i("span",{class:"jlbinding"},"VortexPasta.CellLists.nearby_elements")],-1)),s[29]||(s[29]=e()),t(a,{type:"info",class:"jlObjectType jlFunction",text:"Function"})]),s[31]||(s[31]=n('<div class="language-julia vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">julia</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">nearby_elements</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(cl</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">::</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">PeriodicCellList{N}</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, x⃗)</span></span></code></pre></div><p>Return an iterator over the elements that are sufficiently close to the point <code>x⃗</code>.</p><p>The iterator returns the elements which are likely to be within the cutoff radius of the point <code>x⃗</code>. More precisely, it returns elements in the same cell as <code>x⃗</code> as well as in neighbouring cells.</p><p>Here <code>x⃗</code> should be a coordinate, usually represented by an <code>SVector{N}</code> or an <code>NTuple{N}</code>.</p>',4)),t(a,{type:"info",class:"source-link",text:"source"},{default:l(()=>[...s[30]||(s[30]=[i("a",{href:"https://github.com/jipolanco/VortexPasta.jl/blob/dbbd29218d5d247bbb53e6266b9f5b36a4f04d11/src/CellLists/CellLists.jl#L584-L594",target:"_blank",rel:"noreferrer"},"source",-1)])]),_:1})])])}const j=k(r,[["render",f]]);export{D as __pageData,j as default};
